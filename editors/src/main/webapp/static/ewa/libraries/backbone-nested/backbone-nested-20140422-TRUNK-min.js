/**
 * Backbone-Nested 2.0.0 - An extension of Backbone.js that keeps track of nested attributes
 *
 * http://afeld.github.com/backbone-nested/
 *
 * Copyright (c) 2011-2012 Aidan Feldman
 * MIT Licensed (LICENSE)
 */
(function(a,b){if(typeof exports!=="undefined"){module.exports=b(require("jquery"),require("underscore"),require("backbone"))}else{if(typeof define==="function"&&define.amd){define(["jquery","underscore","backbone"],b)}else{b(a.$,a._,a.Backbone)}}}(this,function(d,c,e){var b=[],a;e.NestedModel=e.Model.extend({get:function(g){var h=e.NestedModel.attrPath(g),f;e.NestedModel.walkPath(this.attributes,h,function(k,j){var i=c.last(j);if(j.length===h.length){f=k[i]}});return f},has:function(g){var f=this.get(g);return !(f===null||c.isUndefined(f))},set:function(l,k,f){var h=e.NestedModel.deepClone(this.attributes),j,i,g;if(c.isString(l)){j=e.NestedModel.attrPath(l)}else{if(c.isArray(l)){j=l}}if(j){f=f||{};this._setAttr(h,j,k,f)}else{f=k||{};var m=l;for(var n in m){if(m.hasOwnProperty(n)){this._setAttr(h,e.NestedModel.attrPath(n),f.unset?void 0:m[n],f)}}}a=e.NestedModel.__super__.changedAttributes.call(this);if(f.unset&&j&&j.length===1){i={};i[l]=void 0;a=c.omit(a,c.keys(i));g=e.NestedModel.__super__.set.call(this,i,f)}else{i=h;if(f.unset&&j){f=c.extend({},f);delete f.unset}else{if(f.unset&&c.isObject(l)){i=l}}a=c.omit(a,c.keys(i));g=e.NestedModel.__super__.set.call(this,i,f)}if(!g){this.changed={};a={};return false}this._runDelayedTriggers();return this},unset:function(f,g){return this.set(f,void 0,c.extend({},g,{unset:true}))},clear:function(h){a={};h=h||{};var g=c.clone(this.attributes);if(!h.silent&&this.validate&&!this.validate(g,h)){return false}var j=this.changed={};var f=this;var i=function(m,l,k){c.each(m,function(p,n){var o=l;if(c.isArray(m)){o+="["+n+"]"}else{if(l){o+="."+n}else{o=n}}p=m[n];if(c.isObject(p)){i(p,o,k)}if(!k.silent){f._delayedChange(o,null,k)}j[o]=null})};i(this.attributes,"",h);this.attributes={};if(!h.silent){this._delayedTrigger("change")}this._runDelayedTriggers();return this},add:function(f,h,g){var i=this.get(f);if(!c.isArray(i)){throw new Error("current value is not an array")}return this.set(f+"["+i.length+"]",h,g)},remove:function(g,f){f=f||{};var n=e.NestedModel.attrPath(g),l=c.initial(n),h=this.get(l),m=c.last(n);if(!c.isArray(h)){throw new Error("remove() must be called on a nested array")}var k=!f.silent&&(h.length>=m+1),j=h[m];h.splice(m,1);f.silent=true;this.set(l,h,f);if(k){g=e.NestedModel.createAttrStr(l);this.trigger("remove:"+g,this,j);for(var o=l.length;o>=1;o--){g=e.NestedModel.createAttrStr(c.first(l,o));this.trigger("change:"+g,this,j)}this.trigger("change",this,j)}return this},changedAttributes:function(g){var f=e.NestedModel.__super__.changedAttributes.call(this,g);if(c.isObject(f)){return c.extend({},a,f)}return false},toJSON:function(){return e.NestedModel.deepClone(this.attributes)},_delayedTrigger:function(){b.push(arguments)},_delayedChange:function(f,h,g){this._delayedTrigger("change:"+f,this,h,g);if(!this.changed){this.changed={}}this.changed[f]=h},_runDelayedTriggers:function(){while(b.length>0){this.trigger.apply(this,b.shift())}},_setAttr:function(h,k,j,i){i=i||{};var g=k.length;var f=this;e.NestedModel.walkPath(h,k,function(m,t,o){var p=c.last(t);var l=e.NestedModel.createAttrStr(t);var r=!c.isEqual(m[p],j);if(t.length===g){if(i.unset){delete m[p];if(c.isArray(m)){var n=e.NestedModel.createAttrStr(c.initial(k));f._delayedTrigger("remove:"+n,f,m[p])}}else{m[p]=j}if(!i.silent&&c.isObject(j)&&r){var q=[];var s=function(y,x){if(c.indexOf(q,y)>-1){return}else{q.push(y)}var u,w;for(var v in y){if(y.hasOwnProperty(v)){u=x+"."+v;w=y[v];if(!c.isEqual(f.get(u),w)){f._delayedChange(u,w,i)}if(c.isObject(w)){s(w,u)}}}};s(j,l)}}else{if(!m[p]){if(c.isNumber(o)){m[p]=[]}else{m[p]={}}}}if(!i.silent){if(t.length>1&&r){f._delayedChange(l,m[p],i)}if(c.isArray(m[p])){f._delayedTrigger("add:"+l,f,m[p])}}})}},{attrPath:function(f){var g;if(c.isString(f)){g=(f==="")?[""]:f.match(/[^\.\[\]]+/g);g=c.map(g,function(h){return h.match(/^\d+$/)?parseInt(h,10):h})}else{g=f}return g},createAttrStr:function(g){var f=g[0];c.each(c.rest(g),function(h){f+=c.isNumber(h)?("["+h+"]"):("."+h)});return f},deepClone:function(f){return d.extend(true,{},f)},walkPath:function(h,l,m,g){var k=h,j;for(var f=0;f<l.length;f++){m.call(g||this,k,l.slice(0,f+1),l[f+1]);j=l[f];k=k[j];if(!k){break}}}});return e}));